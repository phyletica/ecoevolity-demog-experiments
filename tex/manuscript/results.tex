\subsection{Analyses of simulated data}

\subsubsection{Estimating timing and sharing of demographic changes}

The ability of \ecoevolity to estimate the timing of
demographic events
(\fig{}~\ref{fig:valsimsetimesinitial})
and the assignment of populations to the
events
(\fig{}~\ref{fig:valsimsmodelinitial})
was quite poor across all the simulation conditions we initially explored.
For these initial conditions, we simulated \datasets with three populations
that underwent a demographic change, under a variety of distributions on the
relative size of the ancestral population.
These included four gamma probability distributions with a shape of 10 and a
mean of
0.25 (4-fold population increase),
0.5 (2-fold population increase),
2.0 (2-fold population decrease), and
1.0 (no change on average, but a fair amount of variance).
We also used a gamma distribution with a shape of 100 and mean of 1.0
to mimic ``worst-case'' conditions when there was almost no demographic
changes in the history of the populations.
The timing of unique size changes was exponentially distributed with a mean of
0.01 expected substitutions per site.
The expected descendant population size
(scaled by the mutation rate; \epopsize\murate)
was 0.002,
which puts our expectation for the size-change times in units of $4N_e$
generations at 1.25.
Our motivation for this distribution of times was to span values
that were ``easy'' and ``hard'' to estimate;
i.e., a mix of size changes that occurred more recently
than the gene copies coalesced and thus would be generate data with information
about when the change happened,
and those that occurred when few or no gene lineages were left to coalesce, and
thus would generate data with limited information about the timing of the
event.

\ifembed{
\input{fig-sims-event-times-initial.tex}
}{}

\ifembed{
\input{fig-sims-model-initial.tex}
}{}

Under the ``worst-case'' scenario of essentially no population-size change
(bottom row of \figs \ref{fig:valsimsetimesinitial} and
\ref{fig:valsimsmodelinitial}), our method is unable to identify the timing or
model of demographic change.
The method returns the prior on the timing of events 
(bottom row of \fig{}~\ref{fig:valsimsetimesinitial})
and almost always prefers either a model with a single, shared demographic
event (model "000") or independent demographic changes (model "012").
(bottom row of \fig{}~\ref{fig:valsimsmodelinitial}).
This is expected behavior, because there is essentially no information in the
data about the timing of demographic changes, and a Dirichlet process with a
concentration parameter of 1.41422, puts approximately 0.24 prior probability
on the models with one and three events, and 0.515 prior probability on the
three models with two events (approximately 0.17 each).
Thus, with little information, the method prefers one of the two models with
larger prior probability.

Under considerable changes in population size, the method only faired
moderately better at estimating the timing of demographic events
(top three rows of \fig{}~\ref{fig:valsimsetimesinitial}).
The ability to identify the model improved under these
conditions, but the frequency at which the correct model
was preferred only exceeded 50\% for the large population
expansions, and the median posterior support for the correct
model was very small (less than 0.58) under all conditions.
(top three rows of \fig{}~\ref{fig:valsimsmodelinitial}).
Under all simulation conditions, estimates of timing and sharing
of the demographic events are better when using all characters
rather than only variable characters
(second versus third column of \figs
\ref{fig:valsimsetimesinitial}
and
\ref{fig:valsimsmodelinitial}).


We observed numerical problems when the change in population size was
either very recent or old relative to the effective size of the descendant
population.
In such cases either very few or almost all of the gene lineages coalesce in
the descendant branch, providing almost no information about the magnitude or
timing of the population-size change.
In these cases, the data were well explained by no expansion, which could be
achieved in three ways: an expansion time of zero and an ancestral population
size that matched the true population size, an old expansion and a
descendant population size that matched the true population size, or an
intermediate expansion time and both the ancestral and descendant sizes matched the
true time.
The true population size being matched was that of the descendant or ancestral
population if the expansion was old or recent, respectively.
This caused MCMC chains to converge to different regions of parameter
space
(highlighted in orange in \fig{}~\ref{fig:valsimsetimesinitial}).

In an effort to find conditions under which the timing and sharing of
demographic changes could be better estimated, and avoid combinations
of parameter values that caused nonidentifiability problems,
we next explored simulations under distributions on times and population sizes
offset from zero, but with much more recent demographic event times.
% Event time ~ gamma(shape=4.0, scale=0.000475, offset=0.0001); mean 0.002
% relative root size ~ gamma(shape=5.0, scale = 0.04, offset = 0.05); mean 0.25
% relative root size ~ gamma(shape=5.0, scale = 0.09, offset = 0.05); mean 0.5
% relative root size ~ gamma(shape=5.0, scale = 0.79, offset = 0.05); mean 4
% relative root size ~ gamma(shape=5.0, scale = 0.19, offset = 0.05); mean 1
% relative root size ~ gamma(shape=50.0, scale = 0.02, offset = 0.0); mean 1
For the distribution of event times, we used a gamma distribution
with a shape of 4, offset of 0.0001, and a mean of 0.002 (accounting
for the offset; 0.25 units of $4N_e$ generations on average).
In combination with this distribution on event times,
we used five different gamma distributions on the relative
effective size of the ancestral population.
Four of these had a shape of 5, an offset of 0.05, and a mean
of
0.25 (4-fold increase),
0.4 (2-fold increase),
4 (4-fold decrease),
and
1 (no change on average).
The last gamma distribution on the relative ancestral size was a shape of 50
and a mean of 1.

Even when trying to make the simulated conditions ``optimal'' for identifying
the event times, the ability to infer the correct timing and sharing of
demographic events remains quite poor
(\figs \ref{fig:valsimsetimesopt} and \ref{fig:valsimsmodelopt}).
Under the recent (but not too recent) 4-fold population-size increase (on
average) scenario, we do see better estimates of the times of the demographic
change
(top row of \fig{}~\ref{fig:valsimsetimesopt}),
but the ability to idenfify the correct model remains quite poor;
\ecoevolity only prefers the correct model 57\% of the time, with
a median posterior probability of the correct model of 0.42
(top row of \fig{}~\ref{fig:valsimsmodelopt}).
Under the most extreme population retraction scenario (4-fold, on average),
\ecoevolity only estimates the correct model 40\% of the time, with a median
posterior probability of the correct model of only 0.26
(middle row of \fig{}~\ref{fig:valsimsmodelopt}).
Estimates are especially poor when using only variable characters,
so we focus on the results using all characters.
(second versus third column of \figs
\ref{fig:valsimsetimesinitial}
and
\ref{fig:valsimsmodelinitial}).

\ifembed{
\input{fig-sims-event-times-opt.tex}
}{}

\ifembed{
\input{fig-sims-model-opt.tex}
}{}


\subsubsection{But what about under realistic prior information}

We only observe decent estimates of the timing and sharing of demographic
events under narrow distributions on the relative effective size of the
ancestral distribution
(top row of \figs
\labelcref{fig:valsimsetimesinitial,fig:valsimsmodelinitial,fig:valsimsetimesopt,fig:valsimsmodelopt}).
These distributions are unrealistically informative for empirical studies, for
which there is usually little prior information about past population sizes.
To determine whether the improved performance under these distributions
was caused by more informative data or priors, we simulated
\datasets under a narrow distribution on the relative ancestral
population size, and analyzed these \datasets under
more realistic, ``diffuse'' prior distributions on populations sizes
and event times.
For comparison, we repeated the same simulations for pairs of populations for
which we estimated the timing and sharing of their divergences (the same total
number of gene copies were sampled from each pair).

The only conditions under which we obtained moderately good estimates of the
timing and sharing of demographic events
It was a lot of work to find conditions where we could reasonably estimate
the timing and number of demographic change events.
These condtions include quite informative distributions on parameters,
especially the relative size of the ancestral population.
We used the same distribution as the prior, and thus the informative priors
could be why the behavior is better (as opposed to the data containing a strong
signal of what happened).
To determine this, we simulated data under the best conditions,
but then analyzed these data under diffuse priors to see how
well we can expect to estimate.
This is important because in real world applications we usually know very
little about the timing and magnitude (and direction) of size changes.

Sim disributions:

Event time ~ gamma(shape=4.0, scale=0.000475, offset=0.0001); mean 0.002

relative root size ~ gamma(shape=5.0, scale = 0.04, offset = 0.05); mean 0.25

relative root size ~ gamma(shape=5.0, scale = 0.04, offset = 3.8); mean 4.0

descendant size ~ gamma(4.0, scale=0.0005, offset = 0.0001); mean 0.0021

Priors:

Event time ~ exponential(mean = 0.005)

relative root size ~ Exponential(mean = 2.0)

descendant size ~ gamma(2.0, scale 0.001); mean 0.002


\subsection{Simulating a mix of divergence and pop-size-change comparisons}
What if we have a mix of pairs?


\subsection{Simulating linked sites}
Should we analyze all the sites or just unlinked SNPs?


\subsection{Data-acquisition bias?}


\subsection{Empirical application}
Stickleback data.



